# üèÜ Blinkoff IoT Platform (Current State)

**–°—Ç–∞—Ç—É—Å:** Event-Driven Stabilization (Kafka + Watchdog).
**–¢–∏–ø:** Secure Modular Monolith –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è IoT-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (RAM + DB) –∏ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

## üèõ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

* **Modular Monolith:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–æ –Ω–∞ –º–æ–¥—É–ª–∏ `telemetry`, `device_management` –∏ `notification`.
* **Hybrid State Management:**
* **Hot Data (RAM):** –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Å—Ç–∞—Ç—É—Å `Online/Offline`, `LastSeen` –∏ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–≤—è–∑–∫–∏ –∂–∏–≤—É—Ç –≤ –ø–∞–º—è—Ç–∏ (`ConcurrentHashMap`). –ß—Ç–µ–Ω–∏–µ/–ó–∞–ø–∏—Å—å ‚Äî O(1).
* **Cold Data (DB):** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (Write-Behind) –≤ **PostgreSQL** —Ä–∞–∑ –≤ 10 —Å–µ–∫. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Rehydration) –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞.

* **Event-Driven Core:**
* –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –ø–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ) –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ **Apache Kafka**.
* –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (Telegram Bot) –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Ç–æ–ø–∏–∫ –∏ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

* **Security First:**
* **Traffic:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ **AES-128 (GCM)** –¥–ª—è –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
* **Network:** `DeviceHandshakeInterceptor` –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ TCP-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è.
* **Admin API:** –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ `X-Admin-Key`.

---

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

* **Core:** Java 21, Spring Boot 3.4.x.
* **Message Broker:** Apache Kafka (Topic: `iot-alarms`).
* **Database:** PostgreSQL 15 (`JSONB` –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏).
* **Protocols:**
* **WebSocket (Secure):** –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –æ–±–º–µ–Ω –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
* **HTTP REST:** API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

* **Testing:** Testcontainers (Postgres, Kafka), Mockito.

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (Interaction Flows)

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è (Device Lifecycle)

1. **Handshake:** ESP32 —Å—Ç—É—á–∏—Ç—Å—è –≤ `ws://host/ws/device` —Å —Ö–µ–¥–µ—Ä–æ–º `X-Chip-Id`. –°–µ—Ä–≤–µ—Ä —Å–≤–µ—Ä—è–µ—Ç ID —Å `DeviceAuthCache` (RAM).
2. **Connection Event:** –ü—Ä–∏ —É—Å–ø–µ—Ö–µ —Å–µ—Ä–≤–µ—Ä —à–ª–µ—Ç —Å–æ–±—ã—Ç–∏–µ `CONNECTION_ESTABLISHED` –≤ Kafka.
3. **Payload Processing:**
* –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —à–ª–µ—Ç AES-—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π JSON.
* –°–µ—Ä–≤–µ—Ä –¥–µ—à–∏—Ñ—Ä—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç `lastSeen` –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ RAM.
* **–ê–Ω–∞–ª–∏–∑:** –ï—Å–ª–∏ –≤ JSON –µ—Å—Ç—å –ø–æ–ª—è `errors` –∏–ª–∏ `events`, —Å–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è (`DEVICE_ERROR`, `DEVICE_EVENT`) –≤ Kafka.

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –°–≤—è–∑–∏ (Watchdog & Dead Man's Switch)

1. **Polling:** –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (`DeviceConnectivityWatchdog`) –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
2. **Detection:**
* –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ `Online`, –Ω–æ –º–æ–ª—á–∏—Ç > 60 —Å–µ–∫ -> –ü–µ—Ä–µ–≤–æ–¥ –≤ `Offline`, —Å–æ–±—ã—Ç–∏–µ `CONNECTION_LOST_TIMEOUT` (–ø–µ—Ä–µ—Ö–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏—è).
* –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ `Offline` –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –º–æ–ª—á–∞—Ç—å -> –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ `CONNECTION_NOT_FOUND` (Heartbeat of failure) –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
3. **Socket Close:** –ï—Å–ª–∏ —Å–æ–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç —è–≤–Ω–æ (RST/FIN), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ `CONNECTION_BROKEN`.

### 3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Bot Interaction)

1. **Consumer:** –ë–æ—Ç —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka.
2. **Enrichment:** –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É Core API —Å–ø–∏—Å–æ–∫ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –¥–ª—è —ç—Ç–æ–≥–æ `chipId` (`GET /owners`).
3. **Delivery:** –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

---

## üì° API –ö–æ–Ω—Ç—Ä–∞–∫—Ç (Server Interface)

–í—Å–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç JSON. –û—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `{ "status": "ERROR", "message": "...", "timestamp": "..." }`.

### üîê Security Headers

* **Admin/System:** –¢—Ä–µ–±—É—é—Ç `X-Admin-Key: <SECRET_KEY>`.
* **Public/Bot:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç –ª–æ–≥–∏–∫—É —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.

### 1. Device Provisioning & Management (Admin üõ°Ô∏è)

| –ú–µ—Ç–æ–¥ | URL | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã / Body | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- | --- |
| **POST** | `/api/devices/provision` | `{ "chipId": "...", "name": "..." }` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —á–∏–ø–∞. –û—Ç–≤–µ—Ç: **201 Created**. |
| **POST** | `/api/devices/{id}/block` | - | **–ë–ê–ù**. –†–∞–∑—Ä—ã–≤ WS, –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞, —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π. |
| **POST** | `/api/devices/{id}/unblock` | - | **–†–ê–ó–ë–ê–ù**. –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –Æ–∑–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å –∑–∞–Ω–æ–≤–æ. |
| **POST** | `/api/devices/{id}/token` | - | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (TTL 5 –º–∏–Ω) –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏. |
| **GET** | `/api/devices/{id}/owners` | `?platform=TELEGRAM` | **NEW.** –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (chat_id), –≤–ª–∞–¥–µ—é—â–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º. –§–∏–ª—å—Ç—Ä `platform` –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω. |

### 2. User Binding & Data (Bot / Client)

| –ú–µ—Ç–æ–¥ | URL | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã / Body | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- | --- |
| **POST** | `/api/bindings` | `{ "token": "uuid", "userId": "tg_1", "platform": "TELEGRAM" }` | –ü—Ä–∏–≤—è–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ OTP-—Ç–æ–∫–µ–Ω—É. |
| **DELETE** | `/api/bindings` | `?chipId=...&userId=...` | –û—Ç–≤—è–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. |
| **GET** | `/api/devices` | `?userId=...` | –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`DeviceSummaryDto`). –ò–º–µ–Ω–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑ RAM (–µ—Å–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã) –∏–ª–∏ DB. |
| **GET** | `/api/devices/{id}/telemetry` | `?userId=...` | –ü–æ–ª–Ω—ã–π JSON —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. |

---

## ‚ö° WebSocket Contract (Device Protocol)

–ü—Ä–æ—Ç–æ–∫–æ–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ <-> –°–µ—Ä–≤–µ—Ä".

* **URL:** `ws://host:8080/ws/device`
* **Header:** `X-Chip-Id: <CHIP_ID>`
* **–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** –°—Ç—Ä–æ–∫–∞ (Base64), —Å–æ–¥–µ—Ä–∂–∞—â–∞—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π AES-128 JSON.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON (–¥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ø–æ–ª—è `errors` –∏ `events` –∏–º–µ—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

```json
{
  "temp": 37.5,                 // –õ—é–±—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
  "hum": 60.0,
  "name": "My Incubator",       // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤ RAM
  
  // üî• –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞
  "errors": [                   // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –Ω–µ –ø—É—Å—Ç -> –ª–µ—Ç–∏—Ç DEVICE_ERROR
    "Sensor Failure", 
    "Heater Error" 
  ],
  "events": [                   // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –Ω–µ –ø—É—Å—Ç -> –ª–µ—Ç–∏—Ç DEVICE_EVENT
    "Incubation Started",
    "Door Opened"
  ]
}

```

---

## üì£ Kafka Event Contract (Notification System)

–ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (Telegram Bot, Push Service).
**Topic:** `iot-alarms`

### JSON Structure (`DeviceAlarmEvent`)

```json
{
  "chipId": "ESP-TEST-01",
  "type": "DEVICE_ERROR",       // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è (—Å–º. Enum)
  "message": "Critical failure", // –ß–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ª–æ–≥–æ–≤
  "payload": [                  // –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π (–æ—à–∏–±–∫–∏, —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ null)
    "Sensor Failure",
    "Overheat"
  ],
  "timestamp": "2025-12-16T12:00:00Z"
}

```

### Event Types (Enum)

| –¢–∏–ø | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `CONNECTION_ESTABLISHED` | WebSocket | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–æ—Å—å –∏ –ø—Ä–æ—à–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é. |
| `CONNECTION_BROKEN` | WebSocket | –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ —è–≤–Ω–æ (–∑–∞–∫—Ä—ã—Ç —Å–æ–∫–µ—Ç, –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏). |
| `CONNECTION_LOST_TIMEOUT` | Watchdog | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–∏—Å–ª–∏–ª–æ—Å—å Online, –Ω–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–æ —Å–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (>60—Å). –ü–µ—Ä–µ—Ö–æ–¥ –≤ Offline. |
| `CONNECTION_NOT_FOUND` | Watchdog | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–ª–≥–æ Offline. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (Heartbeat of failure). |
| `DEVICE_ERROR` | Device JSON | –í —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –ø—Ä–∏—à–µ–ª –Ω–µ–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `"errors": [...]`. |
| `DEVICE_EVENT` | Device JSON | –í —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –ø—Ä–∏—à–µ–ª –Ω–µ–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `"events": [...]`. |

### üìÇ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∫–ª–∞—Å—Å–æ–≤

```text
src/main/java/com/blinkoff/iot
‚îú‚îÄ‚îÄ BlinkoffIoTApplication.java         // üö¶ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –°–æ–¥–µ—Ä–∂–∏—Ç @EnableScheduling, —á—Ç–æ–±—ã Spring –∑–∞–ø—É—Å–∫–∞–ª —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (Watchdog –∏ SyncService).
‚îÇ
‚îú‚îÄ‚îÄ shared                              // üß± –û–ë–©–ï–ï –Ø–î–†–û (–£—Ç–∏–ª–∏—Ç—ã –∏ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppConstants.java           // üìè –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: –ª–∏–º–∏—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–∞–π–º–∞—É—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤, –∏–º–µ–Ω–∞ —Ç–æ–ø–∏–∫–æ–≤ Kafka.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RedisConfig.java            // üî• NEW: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è RedisTemplate. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é, —á—Ç–æ–±—ã –≤ Redis Commander –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ —á–∏—Ç–∞–µ–º—ã–º–∏, –∞ –Ω–µ –±–∏–Ω–∞—Ä–Ω—ã–º –º—É—Å–æ—Ä–æ–º.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebConfig.java              // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MVC: —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏ (AdminAuthInterceptor) –¥–ª—è –∑–∞—â–∏—Ç—ã API.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebSocketConfig.java        // üîå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è WebSocket —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (/ws/device) –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –Ω–µ–º—É DeviceHandler.
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DataSeeder.java             // üå± –ó–∞–≥—Ä—É–∑—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö: –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î –∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –µ—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞.
‚îÇ   ‚îú‚îÄ‚îÄ exception                       // ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApiError.java               // DTO –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ JSON-–æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ (timestamp, status, message).
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java // @ControllerAdvice: –ª–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, InvalidTokenException) –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ ApiError.
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InvalidTokenException.java  // –ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: –∫–∏–¥–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Redis.
‚îÇ   ‚îî‚îÄ‚îÄ security
‚îÇ       ‚îú‚îÄ‚îÄ AdminAuthInterceptor.java   // üõ°Ô∏è –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ HTTP. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Admin-Key. –ó–∞—â–∏—â–∞–µ—Ç –∞–¥–º–∏–Ω–∫—É –∏ –º–µ—Ç–æ–¥—ã –¥–ª—è –ë–æ—Ç–∞.
‚îÇ       ‚îî‚îÄ‚îÄ crypto                      // üîê –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ           ‚îú‚îÄ‚îÄ AesCryptoEngine.java    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è AES-128 (GCM). –î–µ—à–∏—Ñ—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
‚îÇ           ‚îú‚îÄ‚îÄ KeyProvider.java        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.
‚îÇ           ‚îî‚îÄ‚îÄ StaticKeyProvider.java  // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: –±–µ—Ä–µ—Ç –∫–ª—é—á–∏ –∏–∑ application.yaml (–ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Vault).
‚îÇ
‚îî‚îÄ‚îÄ modules                             // üì¶ –ë–ò–ó–ù–ï–°-–ú–û–î–£–õ–ò
    ‚îÇ
    ‚îú‚îÄ‚îÄ device_management               // üõ† –£–ü–†–ê–í–õ–ï–ù–ò–ï (–•–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ API)
    ‚îÇ   ‚îú‚îÄ‚îÄ controller
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceBindingController.java      // API (User): POST /bind (–ø—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ —Ç–æ–∫–µ–Ω—É), DELETE /bind (–æ—Ç–≤—è–∑–∞—Ç—å).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceDataController.java         // API (User): GET /devices. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —é–∑–µ—Ä–∞, –æ–±—ä–µ–¥–∏–Ω—è—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –∏ Redis.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceProvisioningController.java // API (Admin/Bot): –°–æ–∑–¥–∞–Ω–∏–µ —á–∏–ø–∞, –±–ª–æ–∫/—Ä–∞–∑–±–ª–æ–∫, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤.
    ‚îÇ   ‚îú‚îÄ‚îÄ service
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceProvisioningService.java  // –õ–æ–≥–∏–∫–∞ "–ó–∞–≤–æ–¥–∞": —Å–æ–∑–¥–∞–µ—Ç Device –≤ PostgreSQL, –æ–±–Ω–æ–≤–ª—è–µ—Ç "–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫" –≤ Redis.
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceBindingService.java       // –õ–æ–≥–∏–∫–∞ "–°–≤—è–∑–µ–π": –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ TokenStore, —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ bindings.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceDataService.java          // –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä: –±–µ—Ä–µ—Ç –∏–º—è –∏–∑ –ë–î, —Å—Ç–∞—Ç—É—Å –∏–∑ Redis, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∏–∑ Redis -> —Å–æ–±–∏—Ä–∞–µ—Ç DTO.
    ‚îÇ   ‚îú‚îÄ‚îÄ store
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProvisioningTokenStore.java     // üî• UPD: –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –≤ Redis. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TTL (Time-To-Live), —á—Ç–æ–±—ã Redis —Å–∞–º —É–¥–∞–ª—è–ª –ø—Ä–æ—Ç—É—Ö—à–∏–µ —Ç–æ–∫–µ–Ω—ã.
    ‚îÇ   ‚îú‚îÄ‚îÄ dto
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BindRequest.java        // JSON: { token, userId, platform }
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceSummaryDto.java   // JSON –¥–ª—è —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫—Ä–∞—Ç–∫–æ).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceTelemetryDto.java // JSON –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞ (–ø–æ–ª–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProvisionRequest.java   // JSON –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–∏–ø–∞.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProvisionResponse.java  // –û—Ç–≤–µ—Ç –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
    ‚îÇ   ‚îú‚îÄ‚îÄ model
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enums/PlatformType.java // Enum: TELEGRAM, ANDROID (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª —é–∑–µ—Ä).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enums/AccessRole.java   // Enum: OWNER, VIEWER (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Device.java             // JPA Entity: —Ç–∞–±–ª–∏—Ü–∞ devices.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceBinding.java      // JPA Entity: —Ç–∞–±–ª–∏—Ü–∞ bindings (Many-to-Many —Å–≤—è–∑—å Users <-> Devices).
    ‚îÇ   ‚îî‚îÄ‚îÄ repository
    ‚îÇ       ‚îú‚îÄ‚îÄ DeviceBindingRepository.java // SQL: –ø–æ–∏—Å–∫ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤.
    ‚îÇ       ‚îî‚îÄ‚îÄ DeviceRepository.java        // SQL: CRUD –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
    ‚îÇ
    ‚îú‚îÄ‚îÄ notification                    // üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (Event Bus)
    ‚îÇ   ‚îú‚îÄ‚îÄ event
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceAlarmEvent.java   // üì® DTO —Å–æ–±—ã—Ç–∏—è: ChipId, –¢–∏–ø (ERROR/EVENT/LOST), Payload (—Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫).
    ‚îÇ   ‚îî‚îÄ‚îÄ kafka
    ‚îÇ       ‚îî‚îÄ‚îÄ AlarmProducer.java      // üì£ –ü—Ä–æ–¥—é—Å–µ—Ä: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç DeviceAlarmEvent –≤ —Ç–æ–ø–∏–∫ 'iot-alarms'.
    ‚îÇ
    ‚îî‚îÄ‚îÄ telemetry                       // üå° –¢–ï–õ–ï–ú–ï–¢–†–ò–Ø (–ì–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ WebSocket)
        ‚îú‚îÄ‚îÄ api
        ‚îÇ   ‚îî‚îÄ‚îÄ device_facing
        ‚îÇ       ‚îú‚îÄ‚îÄ DeviceHandler.java              // WebSocket –ª–æ–≥–∏–∫–∞: 1. –ü—Ä–∏–Ω—è—Ç—å 2. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å 3. –û–±–Ω–æ–≤–∏—Ç—å Redis 4. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ -> Kafka.
        ‚îÇ       ‚îî‚îÄ‚îÄ DeviceHandshakeInterceptor.java // "–í—ã—à–∏–±–∞–ª–∞": –ø—Ä–æ–≤–µ—Ä—è–µ—Ç X-Chip-Id –ø–µ—Ä–µ–¥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –°–º–æ—Ç—Ä–∏—Ç –≤ Redis Whitelist.
        ‚îú‚îÄ‚îÄ service
        ‚îÇ   ‚îî‚îÄ‚îÄ DeviceAuthCache.java    // üî• UPD: –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ Redis Set ('device:auth:whitelist'). –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ "–†–∞–∑—Ä–µ—à–µ–Ω –ª–∏ —ç—Ç–æ—Ç —á–∏–ø?".
        ‚îú‚îÄ‚îÄ store
        ‚îÇ   ‚îî‚îÄ‚îÄ RedisDeviceStateStore.java // üî• NEW: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ Redis Hash. –ö–ª—é—á–∏: 'device:state:{id}'. –ü–æ–ª—è: params, isOnline, lastSeen.
        ‚îú‚îÄ‚îÄ engine
        ‚îÇ   ‚îú‚îÄ‚îÄ StateSyncService.java           // üï∞ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä: –†–∞–∑ –≤ N —Å–µ–∫—É–Ω–¥ –±–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ PostgreSQL (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏).
        ‚îÇ   ‚îî‚îÄ‚îÄ DeviceConnectivityWatchdog.java // üêï –°—Ç–æ—Ä–æ–∂: –†–∞–∑ –≤ 10 —Å–µ–∫ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç Redis. –ï—Å–ª–∏ lastSeen —Å—Ç–∞—Ä—ã–π -> —Å—Ç–∞–≤–∏—Ç Offline –≤ Redis -> —à–ª–µ—Ç Alert –≤ Kafka.
        ‚îú‚îÄ‚îÄ model
        ‚îÇ   ‚îî‚îÄ‚îÄ DeviceState.java        // JPA Entity: —Ç–∞–±–ª–∏—Ü–∞ device_states (JSONB params, last_seen).
        ‚îî‚îÄ‚îÄ repository
            ‚îî‚îÄ‚îÄ DeviceStateRepository.java // SQL: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –ë–î.
```

-----

### üîÑ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –°—Ü–µ–Ω–∞—Ä–∏–∏ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (Interaction Flows)

#### 1. üöÄ –°—Ç–∞—Ä—Ç –°–∏—Å—Ç–µ–º—ã (System Warmup)

*–¶–µ–ª—å: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Redis ("–≥–æ—Ä—è—á—É—é" –ø–∞–º—è—Ç—å) —Å PostgreSQL ("—Ö–æ–ª–æ–¥–Ω—ã–º" —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º) –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã Watchdog –Ω–µ —Å—á–∏—Ç–∞–ª –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–µ—Ä—Ç–≤—ã–º–∏.*

1. **Boot:** Spring –∑–∞–ø—É—Å–∫–∞–µ—Ç `BlinkoffIoTApplication`.
2. **Auth Cache Warmup:**
* `DeviceAuthCache` (@PostConstruct) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É `DeviceRepository` —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö `chip_id`.
* –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Ö –≤ **Redis Set** (`device:auth:whitelist`).
3. **State Warmup:**
* `StateSyncService` (@PostConstruct) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É `DeviceStateRepository` –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
* –í—ã–∑—ã–≤–∞–µ—Ç `RedisDeviceStateStore`, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø–æ–ª–Ω—è–µ—Ç **Redis Hash** (`device:state:{id}`) –¥–∞–Ω–Ω—ã–º–∏ (`params`, `lastSeen`), –Ω–æ —Å—Ç–∞–≤–∏—Ç `isOnline = false` (—Ç–∞–∫ –∫–∞–∫ —Å–æ–∫–µ—Ç—ã –µ—â–µ –Ω–µ –ø–æ–¥–Ω—è—Ç—ã).

---

#### 2. üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Device Connection Handshake)

*–¶–µ–ª—å: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ —É–≤–µ–¥–æ–º–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.*

1. **Request:** ESP32 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-Chip-Id`.
2. **Intercept:** `DeviceHandshakeInterceptor` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏.
3. **Check:** –ò–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `DeviceAuthCache`.
* –¢–æ—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ **Redis**: `SISMEMBER device:auth:whitelist <chipId>`.
* *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –ï—Å–ª–∏ `false` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è (403 Forbidden).


4. **Session Open:** –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `DeviceHandler`.
5. **State Update:** `DeviceHandler` –≤—ã–∑—ã–≤–∞–µ—Ç `RedisDeviceStateStore.setOnline(true)`.
6. **Event:** `DeviceHandler` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `AlarmProducer`, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ `CONNECTION_ESTABLISHED` –≤ Kafka.

---

#### 3. üå° –û–±—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–º–µ—Ç—Ä–∏–∏ (Telemetry Processing)

*–¶–µ–ª—å: –ü—Ä–∏–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ "–≥–æ—Ä—è—á—É—é" –ø–∞–º—è—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∞–≤–∞—Ä–∏–∏.*

1. **Incoming Message:** `DeviceHandler` –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ WebSocket.
2. **Decrypt:** `DeviceHandler` –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ `AesCryptoEngine`. –¢–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π JSON.
3. **Save Hot State:**
* `DeviceHandler` –≤—ã–∑—ã–≤–∞–µ—Ç `RedisDeviceStateStore.updateParams(json)`.
* –°—Ç–æ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É Redis `HMSET` (–æ–±–Ω–æ–≤–ª—è–µ—Ç `params`, —Å—Ç–∞–≤–∏—Ç `lastSeen = now()`, `isOnline = true`).
4. **Alarm Analysis:**
* `DeviceHandler` –ø–∞—Ä—Å–∏—Ç JSON.
* –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ `errors` –Ω–µ –ø—É—Å—Ç -> –≤—ã–∑—ã–≤–∞–µ—Ç `AlarmProducer` (—Ç–∏–ø `DEVICE_ERROR`).
* –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ `events` –Ω–µ –ø—É—Å—Ç -> –≤—ã–∑—ã–≤–∞–µ—Ç `AlarmProducer` (—Ç–∏–ø `DEVICE_EVENT`).
* –í—Å–µ —Å–æ–±—ã—Ç–∏—è —É–ª–µ—Ç–∞—é—Ç –≤ —Ç–æ–ø–∏–∫ `iot-alarms`.

---

#### 4. üêï –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –°–≤—è–∑–∏ (Watchdog Cycle)

*–¶–µ–ª—å: –û–±–Ω–∞—Ä—É–∂–∏—Ç—å "–º–æ–ª—á–∞—â–∏–µ" —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.*

1. **Trigger:** `@Scheduled` –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–æ–¥ `checkConnectivity()` –≤ `DeviceConnectivityWatchdog` (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫).
2. **Fetch List:** Watchdog –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∏–ø–æ–≤ —É `DeviceAuthCache` (Redis: `SMEMBERS`).
3. **Check Status:** –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∏–ø–∞ Watchdog –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É `RedisDeviceStateStore` –ø–æ–ª—è `lastSeen` –∏ `isOnline`.
4. **Logic:**
* **–°—Ü–µ–Ω–∞—Ä–∏–π –ê (–¢–∞–π–º–∞—É—Ç):** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ `isOnline=true`, –Ω–æ `now - lastSeen > 60 sec`.
* Watchdog –≤—ã–∑—ã–≤–∞–µ—Ç `RedisDeviceStateStore.setOnline(false)`.
* Watchdog –≤—ã–∑—ã–≤–∞–µ—Ç `AlarmProducer` -> Kafka (`CONNECTION_LOST_TIMEOUT`).
* **–°—Ü–µ–Ω–∞—Ä–∏–π –ë (–ü—Ä–∏–∑—Ä–∞–∫):** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ `isOnline=false` –∏ –¥–∞–≤–Ω–æ –º–æ–ª—á–∏—Ç.
* Watchdog –≤—ã–∑—ã–≤–∞–µ—Ç `AlarmProducer` -> Kafka (`CONNECTION_NOT_FOUND`) –¥–ª—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (Heartbeat of failure).

---

#### 5. üíæ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î (Persisting State)

*–¶–µ–ª—å: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ PostgreSQL, –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è –±–∞–∑—É –∫–∞–∂–¥—ã–º –ø–∞–∫–µ—Ç–æ–º —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏.*

1. **Trigger:** `@Scheduled` –∑–∞–ø—É—Å–∫–∞–µ—Ç `StateSyncService` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ 30 —Å–µ–∫).
2. **Snapshot:** –°–µ—Ä–≤–∏—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É `RedisDeviceStateStore` –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Redis: `SCAN` –∏–ª–∏ `KEYS`).
3. **Write:** –°–µ—Ä–≤–∏—Å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç Batch-–∑–∞–ø—Ä–æ—Å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏ `DeviceState` –≤ PostgreSQL —á–µ—Ä–µ–∑ `DeviceStateRepository`.

---

#### 6. üõ† –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Admin Provisioning)

*–¶–µ–ª—å: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Å–∏—Å—Ç–µ–º—É.*

1. **API Call:** –ê–¥–º–∏–Ω —à–ª–µ—Ç `POST /api/devices/provision` —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-Admin-Key`.
2. **Security:** `AdminAuthInterceptor` —Å–≤–µ—Ä—è–µ—Ç –∫–ª—é—á.
3. **Persist (Cold):** `DeviceProvisioningService` —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `DeviceRepository` (Postgres).
4. **Persist (Hot):** –°–µ—Ä–≤–∏—Å —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç ChipId –≤ `DeviceAuthCache` (Redis: `SADD device:auth:whitelist`).
* *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è —Å—Ä–∞–∑—É, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

#### 7. üîó –ü—Ä–∏–≤—è–∑–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Token Binding)

*–¶–µ–ª—å: –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Å–≤—è–∑–∞—Ç—å Telegram-–∞–∫–∫–∞—É–Ω—Ç —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.*

1. **Token Gen:** –ê–¥–º–∏–Ω –≤—ã–∑—ã–≤–∞–µ—Ç `POST /api/devices/{id}/token`.
* `ProvisioningTokenStore` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç UUID.
* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis: `SET provisioning:token:{uuid} {chipId} EX 300` (TTL 5 –º–∏–Ω—É—Ç).
2. **User Input:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ë–æ—Ç—É. –ë–æ—Ç —à–ª–µ—Ç `POST /api/bindings`.
3. **Validation:**
* `DeviceBindingService` –≤—ã–∑—ã–≤–∞–µ—Ç `ProvisioningTokenStore.consumeToken(token)`.
* –°—Ç–æ—Ä –¥–µ–ª–∞–µ—Ç Redis `GETDEL` (–ü–æ–ª—É—á–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ). –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è `null` ‚Äî –æ—à–∏–±–∫–∞.
4. **Binding:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `DeviceBindingRepository` (Postgres).

---

#### 8. üì± –ü—Ä–æ—Å–º–æ—Ç—Ä –î–∞–Ω–Ω—ã—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Hybrid Read)

*–¶–µ–ª—å: –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.*

1. **API Call:** –Æ–∑–µ—Ä (—á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/–±–æ—Ç–∞) –¥–µ–ª–∞–µ—Ç `GET /api/devices`.
2. **Aggregation:** `DeviceDataService` –¥–µ–ª–∞–µ—Ç –¥–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞:
* **Postgres:** –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –∏–º—è, —Ä–æ–ª—å).
* **Redis:** –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (`params`, `isOnline`) —á–µ—Ä–µ–∑ `RedisDeviceStateStore`.
3. **Merge:** –°–µ—Ä–≤–∏—Å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ.
* *–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–º–µ–Ω–∏:* –ï—Å–ª–∏ –≤ Redis (–≤ JSON params) –µ—Å—Ç—å –ø–æ–ª–µ `name`, –æ–Ω–æ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∏–º—è –∏–∑ Postgres.
4. **Response:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `List<DeviceSummaryDto>`.

---

#### 9. üîî –î–æ—Å—Ç–∞–≤–∫–∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Notification Loop)

*–¶–µ–ª—å: –û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –∏–Ω—Ü–∏–¥–µ–Ω—Ç–µ.*

1. **Kafka Consumer:** –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (–ë–æ—Ç) –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ç–æ–ø–∏–∫–∞ `iot-alarms`.
2. **Enrichment:** –ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç Core API: `GET /api/devices/{chipId}/owners?platform=TELEGRAM`.
3. **Lookup:**
* `DeviceProvisioningController` –≤—ã–∑—ã–≤–∞–µ—Ç `DeviceBindingService`.
* –°–µ—Ä–≤–∏—Å –∏–¥–µ—Ç –≤ `DeviceBindingRepository` –∏ –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ `user_id` (Chat ID) –¥–ª—è —ç—Ç–æ–≥–æ —á–∏–ø–∞ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã `TELEGRAM`.
4. **Delivery:** –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram.

## üß™ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤ (–ê–∫—Ç—É–∞–ª—å–Ω–∞—è)

```text
src/test/java/com/blinkoff/iot
‚îú‚îÄ‚îÄ AbstractRedisTest.java              // üõ† BASE: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Testcontainers (–ø–æ–¥–Ω–∏–º–∞–µ—Ç Redis –¥–ª—è —Ç–µ—Å—Ç–æ–≤).
‚îÇ
‚îú‚îÄ‚îÄ shared
‚îÇ   ‚îî‚îÄ‚îÄ security
‚îÇ       ‚îú‚îÄ‚îÄ AdminAuthInterceptorTest.java       // ‚úÖ UNIT: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –∫–ª—é—á—É.
‚îÇ       ‚îî‚îÄ‚îÄ crypto
‚îÇ           ‚îî‚îÄ‚îÄ AesCryptoEngineTest.java        // ‚úÖ UNIT: AES-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ.
‚îÇ
‚îî‚îÄ‚îÄ modules
    ‚îú‚îÄ‚îÄ device_management
    ‚îÇ   ‚îú‚îÄ‚îÄ service
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceProvisioningServiceTest.java // ‚úÖ UNIT: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Mock Repos).
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceBindingServiceTest.java      // ‚úÖ UNIT: –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceDataServiceTest.java         // ‚úÖ UNIT: –°–±–æ—Ä–∫–∞ DTO.
    ‚îÇ   ‚îú‚îÄ‚îÄ store
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProvisioningTokenStoreTest.java    // üê≥ REDIS: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏, —á—Ç–µ–Ω–∏—è –∏ TTL —Ç–æ–∫–µ–Ω–æ–≤.
    ‚îÇ   ‚îú‚îÄ‚îÄ controller
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceProvisioningControllerTest.java // ‚úÖ WEB: MockMvc —Ç–µ—Å—Ç—ã API.
    ‚îÇ   ‚îú‚îÄ‚îÄ repository
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceRepositoryTest.java          // üê¢ INTEG: JPA/SQL –∑–∞–ø—Ä–æ—Å—ã.
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceBindingRepositoryTest.java   // üê¢ INTEG: Constraints, –∫–∞—Å—Ç–æ–º–Ω—ã–µ query.
    ‚îÇ
    ‚îú‚îÄ‚îÄ notification
    ‚îÇ   ‚îî‚îÄ‚îÄ kafka
    ‚îÇ       ‚îî‚îÄ‚îÄ AlarmProducerTest.java             // ‚úÖ UNIT: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞ KafkaTemplate (Mock).
    ‚îÇ
    ‚îî‚îÄ‚îÄ telemetry
        ‚îú‚îÄ‚îÄ api
        ‚îÇ   ‚îî‚îÄ‚îÄ device_facing
        ‚îÇ       ‚îî‚îÄ‚îÄ DeviceHandlerTest.java         // ‚úÖ UNIT: WebSocket –ª–æ–≥–∏–∫–∞ + Mock RedisStore.
        ‚îú‚îÄ‚îÄ service
        ‚îÇ   ‚îî‚îÄ‚îÄ DeviceAuthCacheTest.java           // üê≥ REDIS: Whitelist (Set operations).
        ‚îú‚îÄ‚îÄ store
        ‚îÇ   ‚îî‚îÄ‚îÄ RedisDeviceStateStoreTest.java     // üê≥ REDIS: –ü—Ä–æ–≤–µ—Ä–∫–∞ Hash-—Å—Ç—Ä—É–∫—Ç—É—Ä, JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
        ‚îú‚îÄ‚îÄ engine
        ‚îÇ   ‚îú‚îÄ‚îÄ StateSyncServiceTest.java          // ‚úÖ UNIT: –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Mock Store & Repo).
        ‚îÇ   ‚îî‚îÄ‚îÄ DeviceConnectivityWatchdogTest.java// ‚úÖ UNIT: –õ–æ–≥–∏–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ (Mock Store).
        ‚îî‚îÄ‚îÄ repository
            ‚îî‚îÄ‚îÄ DeviceStateRepositoryTest.java     // üê¢ INTEG: JPA –∑–∞–ø—Ä–æ—Å—ã (Postgres).

```

### üóù –õ–µ–≥–µ–Ω–¥–∞:

* ‚úÖ **UNIT:** –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏ (`Mockito`).
* üê¢ **INTEG:** –¢–µ—Å—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`@DataJpaTest` + Testcontainers Postgres).
* üê≥ **REDIS:** –¢–µ—Å—Ç—ã —Ö—Ä–∞–Ω–∏–ª–∏—â (`@SpringBootTest` + Testcontainers Redis).
* üõ† **BASE:** –°–ª—É–∂–µ–±–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
